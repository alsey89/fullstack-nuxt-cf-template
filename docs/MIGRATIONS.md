# Database Migrations

Reference for the D1 migration system.

---

## Architecture

### Migration Tracking

Migrations are tracked by **wrangler's built-in `d1_migrations` table**. Rollback bookmarks are logged to `server/database/operations/operations.log` when running production migrations.

### Components

1. **Migration Files** (`server/database/migrations/*.sql`)
   - SQL migrations generated by Drizzle or written manually
   - Applied by wrangler in filename order

2. **Production Migration Script** (`server/database/operations/migrate-production.ts`)
   - Captures Time Travel bookmark before migration
   - Logs operation to `operations.log`
   - Provides rollback command if needed

3. **D1 Time Travel**
   - 30-day rollback history (Cloudflare limitation)
   - Restore via bookmark or timestamp

---

## Migration Workflow

### Local Development

```bash
# 1. Edit schema
# server/database/schema/*.ts

# 2. Generate migration
npm run db:generate

# 3. Apply locally
npm run db:migrate:local:staging

# 4. Test
npm run dev
```

### Staging Deployment

```bash
npm run db:migrate:remote:staging
```

### Production Deployment

```bash
npm run db:migrate:remote:production
# Captures bookmark, asks for confirmation, provides rollback command
```

---

## Commands

| Command | Description |
|---------|-------------|
| `npm run db:generate` | Generate migration from schema changes |
| `npm run db:migrate:local:staging` | Apply migrations locally |
| `npm run db:migrate:remote:staging` | Apply migrations to staging |
| `npm run db:migrate:remote:production` | Apply migrations to production (with safety checks) |
| `npm run db:reset:local:staging` | Reset local DB and reapply migrations |

---

## Rollback

### Using Time Travel

```bash
# Get current bookmark
wrangler d1 time-travel info template-production --config=wrangler.production.jsonc

# Restore from bookmark (from operations.log or migration output)
wrangler d1 time-travel restore template-production --bookmark=<BOOKMARK_ID>

# Or restore to timestamp
wrangler d1 time-travel restore template-production --timestamp="2025-01-10T14:30:00Z"
```

### Operations Log

Check `server/database/operations/operations.log` for production migration history and rollback bookmarks.

---

## Migration Templates

### Add Column (Non-Breaking)

```sql
ALTER TABLE payments ADD COLUMN new_field TEXT;
CREATE INDEX payments_new_field_idx ON payments(new_field);
```

### Drop Table

```sql
DROP TABLE IF EXISTS `old_table`;
```

### Two-Phase Migration (Breaking Changes)

**Phase 1: Expand**
```sql
ALTER TABLE users ADD COLUMN new_name TEXT;
UPDATE users SET new_name = old_name WHERE new_name IS NULL;
```

**Phase 2: Contract** (after code deploys)
```sql
-- SQLite requires table recreation to drop columns
CREATE TABLE users_new AS
  SELECT id, new_name, email, created_at, updated_at
  FROM users;

DROP TABLE users;
ALTER TABLE users_new RENAME TO users;
CREATE INDEX users_email_idx ON users(email);
```

---

## D1 Limitations

- **No multi-request transactions** - BEGIN/COMMIT don't work across API calls
- **100 statement limit** - Batch operations max 100 statements
- **30-day Time Travel** - Only 30 days of rollback history
- **No DROP COLUMN** - SQLite requires table recreation
- **Foreign keys always enabled** - D1 ignores `PRAGMA foreign_keys = OFF`

---

## Best Practices

### DO

- Test locally before staging
- Deploy to staging before production
- Capture Time Travel bookmarks before risky changes
- Use two-phase migrations for breaking changes

### DON'T

- Skip local/staging testing
- Combine schema + data changes in one migration
- Modify production without rollback plan
- Delete Time Travel bookmarks within 30 days

---

## Related Files

- **Production Migration Script:** `server/database/operations/migrate-production.ts`
- **Operations Log:** `server/database/operations/operations.log`
- **Schema Files:** `server/database/schema/`
